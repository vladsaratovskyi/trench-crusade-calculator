{% extends "calculator/base.html" %}
{% block content %}
    <p class="lead">
        Pick attacker/target profiles, optionally pick a weapon (its keywords apply), then layer situational modifiers to see hit and injury odds.
    </p>
    <div class="layout">
        <div class="card">
            <p class="section-title">Attack setup</p>
            <form method="post" novalidate>
                {% csrf_token %}
                {% if attack_form.errors %}
                    <div class="alert">Please fix the highlighted fields.</div>
                {% endif %}
                <div>
                    <label for="{{ attack_form.attacker_profile.id_for_label }}">{{ attack_form.attacker_profile.label }}</label>
                    {{ attack_form.attacker_profile }}
                    {{ attack_form.attacker_profile.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.defender_profile.id_for_label }}">{{ attack_form.defender_profile.label }}</label>
                    {{ attack_form.defender_profile }}
                    {{ attack_form.defender_profile.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.weapon.id_for_label }}">{{ attack_form.weapon.label }}</label>
                    {{ attack_form.weapon }}
                    {{ attack_form.weapon.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.attack_type.id_for_label }}">{{ attack_form.attack_type.label }}</label>
                    {{ attack_form.attack_type }}
                    <small style="color: var(--muted); display:block; margin-top:4px;">If a weapon is chosen, its range type overrides this toggle.</small>
                    {{ attack_form.attack_type.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.hit_target_number.id_for_label }}">{{ attack_form.hit_target_number.label }}</label>
                    {{ attack_form.hit_target_number }}
                    {{ attack_form.hit_target_number.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.extra_hit_dice_mod.id_for_label }}">{{ attack_form.extra_hit_dice_mod.label }}</label>
                    {{ attack_form.extra_hit_dice_mod }}
                    {{ attack_form.extra_hit_dice_mod.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.hit_roll_mod.id_for_label }}">{{ attack_form.hit_roll_mod.label }}</label>
                    {{ attack_form.hit_roll_mod }}
                    {{ attack_form.hit_roll_mod.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.injury_dice_mod.id_for_label }}">{{ attack_form.injury_dice_mod.label }}</label>
                    {{ attack_form.injury_dice_mod }}
                    {{ attack_form.injury_dice_mod.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.injury_roll_mod.id_for_label }}">{{ attack_form.injury_roll_mod.label }}</label>
                    {{ attack_form.injury_roll_mod }}
                    {{ attack_form.injury_roll_mod.errors }}
                </div>
                <div>
                    <label for="{{ attack_form.extra_target_armor.id_for_label }}">{{ attack_form.extra_target_armor.label }}</label>
                    {{ attack_form.extra_target_armor }}
                    {{ attack_form.extra_target_armor.errors }}
                </div>
                <div class="checkbox-row">
                    {{ attack_form.weapon_is_critical }}<label for="{{ attack_form.weapon_is_critical.id_for_label }}">{{ attack_form.weapon_is_critical.label }}</label>
                    {{ attack_form.weapon_is_critical.errors }}
                </div>
                <div class="actions">
                    <button type="submit" name="run_calc" value="1">Recalculate</button>
                </div>
            </form>
        </div>

        <div class="card">
            {% if results %}
                <p class="section-title">Results</p>
                <div class="chip-row">
                    <div class="chip">
                        <small>Attacker</small>
                        <strong>{{ results.attacker.name }}</strong>
                    </div>
                    <div class="chip">
                        <small>Attacker weapons</small>
                        <strong>
                            {% if results.attacker_weapons %}
                                {{ results.attacker_weapons|join:", " }}
                            {% else %}
                                None
                            {% endif %}
                        </strong>
                    </div>
                    <div class="chip">
                        <small>Weapon</small>
                        <strong>
                            {% if results.weapon %}
                                {{ results.weapon.name }} ({{ results.weapon.weapon_type|capfirst }}, {{ results.weapon.range_type|capfirst }}{% if results.weapon.range_inches %} {{ results.weapon.range_inches }}" {% endif %})
                            {% else %}
                                None
                            {% endif %}
                        </strong>
                    </div>
                    <div class="chip">
                        <small>Target</small>
                        <strong>{{ results.defender.name }}</strong>
                    </div>
                    <div class="chip">
                        <small>Attack type</small>
                        <strong>{{ results.attack_type|capfirst }}</strong>
                    </div>
                </div>
                <div class="chip-row">
                    <div class="chip">
                        <small>Hit dice mod</small>
                        <strong>{{ results.base_hit_dice_mod }} base, {{ results.keyword_hit_mod }} unit keywords, {{ results.weapon_hit_mod }} weapon keywords, {{ results.extra_hit_dice_mod }} extra = {{ results.hit_dice_mod }}</strong>
                    </div>
                    <div class="chip">
                        <small>Armor applied</small>
                        <strong>{{ results.base_armor }} base, {{ results.keyword_armor_mod }} keywords, {{ results.extra_target_armor }} extra = {{ results.target_armor }}</strong>
                    </div>
                    <div class="chip">
                        <small>Hit TN / roll mod</small>
                        <strong>{{ results.hit_target_number }} TN, {{ results.hit_roll_mod }} roll mod</strong>
                    </div>
                    <div class="chip">
                        <small>Injury mods</small>
                        <strong>{{ results.injury_dice_mod }}d, {{ results.injury_roll_mod }} roll mod</strong>
                    </div>
                </div>
                <div class="chip-row">
                    <div class="chip">
                        <small>Attacker keywords</small>
                        <strong>
                            {% if results.attacker_keywords %}
                                {{ results.attacker_keywords|join:", " }}
                            {% else %}
                                None
                            {% endif %}
                        </strong>
                    </div>
                    <div class="chip">
                        <small>Weapon keywords</small>
                        <strong>
                            {% if results.weapon_keywords %}
                                {{ results.weapon_keywords|join:", " }}
                            {% else %}
                                None
                            {% endif %}
                        </strong>
                    </div>
                    <div class="chip">
                        <small>Target keywords</small>
                        <strong>
                            {% if results.defender_keywords %}
                                {{ results.defender_keywords|join:", " }}
                            {% else %}
                                None
                            {% endif %}
                        </strong>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat">
                        <small>Hit chance</small>
                        <div class="value">{{ results.hit_probability }}</div>
                    </div>
                    <div class="stat">
                        <small>Miss chance</small>
                        <div class="value">{{ results.miss_probability }}</div>
                    </div>
                    <div class="stat">
                        <small>Any injury</small>
                        <div class="value">{{ results.any_injury_probability }}</div>
                    </div>
                </div>

                <div>
                    {% for band in results.bands %}
                        <div class="band">
                            <div class="band-title">
                                <span>{{ band.label }}</span>
                                <strong>{{ band.percent }}</strong>
                            </div>
                            <div class="bar">
                                <span style="width: {{ band.percent }};"></span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <p class="lead" style="margin-top: 6px;">
                    Injury bands use the default steps: 2-6 Flesh Wound, 7-8 Down, 9+ Out of Action.
                </p>
            {% else %}
                <p class="lead">Add a profile and submit the attack form to see probabilities.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}
